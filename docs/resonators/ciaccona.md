# 夏空 (Ciaccona) - 连招逻辑分析

## 基本信息

| 属性 | 值 |
|------|------|
| 角色名称 | 夏空 (Ciaccona) |
| 角色定位 | Support（辅助） |
| 元素属性 | 气动 (Aero) |
| 协奏类型 | 绿圈 (concerto_aero) |
| 版本 | v2.3 |
| 源文件 | `src/core/combat/resonator/ciaccona.py` |

## 角色机制

夏空是枪系角色（与菲比共用枪系特殊操作），核心机制包括：

- **音律能量** - 3格能量条，满3格时重击加一层风蚀
- **风蚀层数** - 普攻第四段、E技能、变奏可加风蚀层
- **大招唱歌** - R技能进入唱歌状态，持续约34.5秒
- **唱歌状态不切人** - 通过 `_is_singing` 标记，唱歌期间不切换角色

### 音律能量

| 操作 | 效果 |
|------|------|
| 普攻第四段 | +1格音律能量 |
| 变奏 | +1格音律能量 |
| 3格能量重击 | 消耗3格，加一层风蚀 |

## 技能状态检测

### 能量检测

| 检测项 | 检测方式 | 说明 |
|--------|----------|------|
| 音律1格 | 检测第1段能量像素为绿色 | 音律1格 |
| 音律2格 | 检测第2段能量像素 | 音律2格 |
| 音律3格 | 检测第3段能量像素 | 音律满（可重击） |

### 技能检测

| 检测项 | 图标颜色 | 说明 |
|--------|----------|------|
| 共鸣技能 E | 白色 `(255,255,255)` | E技能就绪 |
| 声骸技能 Q | 白色 `(255,255,255)` | 声骸就绪 |
| 共鸣解放 R | 白色/多种绿色 | 大招就绪 |

### 动态状态

```python
_is_singing = False              # 是否在唱歌状态
_singing_timeout_seconds = 34.5  # 唱歌超时时间
_singing_start_time = None       # 唱歌开始时间
```

## 连招片段

| 方法 | 描述 | 说明 |
|------|------|------|
| `a4()` | 4段普攻 | 完整4段普攻 |
| `a_intro()` | 变奏入场普攻 | 1.3秒覆盖变奏时间 |
| `a2_end()` | 后2段普攻 | 普攻第3-4段 |
| `z_musical_essence_3()` | 3格音律重击 | 长按1.54秒重击 |
| `E()` | E技能 | 两次冗余按E |
| `E3a()` | E+3段普攻 | E后从第2段普攻开始 |
| `jEz()` | 跳+E+重击 | 空中E接3音律重击 |
| `jEaaa()` | 跳+3段普攻 | 跳接普攻（方法名有E但实际不含e按键） |
| `jEaaajaaa()` | 双循环跳E普攻 | 两轮跳E普攻循环 |
| `jaaa()` | 跳+3段普攻 | 空中下落接普攻 |
| `Q()` | 声骸技能 | 声骸释放 |
| `R_aero_erosion()` | R风蚀 | 大招风蚀模式 |
| `R_spectro_frazzle()` | R光噪 | 大招光噪模式 |

## 连招决策逻辑 (`combo()`)

```
入场: 退出唱歌状态 + a_intro() 变奏普攻（1.3秒）

截图检测能量和技能状态
释放声骸 Q()

1. 有R（大招就绪）:
   ├─ 3格音律:
   │   ├─ 有E → jEz() 空中E+重击
   │   └─ 无E → z_musical_essence_3() 重击
   ├─ 非3格:
   │   ├─ 有E → jEaaa() 空中E+普攻
   │   └─ 无E → jaaa() 空中普攻
   └─ R_aero_erosion() 释放大招
   └─ 标记唱歌状态
   └─ return

2. 无R:
   ├─ 3格音律 → z_musical_essence_3() 重击
   ├─ 有E:
   │   ├─ 2格 → jEaaa()
   │   └─ 其他 → jEaaajaaa() 双循环
   ├─ 无E → a2_end() 普攻
   └─ 再次检查:
       ├─ 3格音律 → z_musical_essence_3()
       ├─ 有R → R_aero_erosion() + 标记唱歌
       └─ 无R → 结束
```

## 设计特点

1. **唱歌状态保护** - `is_singing()` 方法检查唱歌状态，唱歌期间 CombatSystem 不会切换夏空下场
2. **入场自动退出** - 切入夏空时自动调用 `_set_singing(False)` 退出唱歌状态
3. **音律能量优先** - 3格音律时优先释放重击叠风蚀
4. **大招优先级最高** - 有R时优先围绕R进行连招
5. **TODO 标记** - 代码中标记了光噪/风蚀选择待实现

---

*最后更新: 2026-02-06*
