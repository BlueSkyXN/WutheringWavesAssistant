# 椿 (Camellya) - 连招逻辑分析

## 基本信息

| 属性 | 值 |
|------|------|
| 角色名称 | 椿 (Camellya) |
| 角色定位 | MainDPS（主输出） |
| 元素属性 | 湮灭 (Havoc) |
| 协奏类型 | 紫圈 (concerto_havoc) |
| 版本 | v1.4 |
| 源文件 | `src/core/combat/resonator/camellya.py` |

## 技能状态检测

### 能量检测

| 检测项 | 类型 | 检测方式 |
|--------|------|----------|
| 能量满 | 单级（0/1） | 检测血条上方能量条末端像素是否为紫色 `(131-135, 48-66, 255)` |

### 技能检测

| 检测项 | 图标颜色 | 逻辑 | 说明 |
|--------|----------|------|------|
| 共鸣技能 - 红椿盛绽 | 白色 `(255,255,255)` | AND | 进入盛绽状态（白椿→红椿） |
| 共鸣技能 - 黯蕊猎心 | 白色 `(255,255,255)` | AND | 退出盛绽状态（红椿→白椿） |
| 共鸣技能 - 一日花 | 白色 `(255,255,255)` | AND | 特殊技能，消耗红椿·蕾 |
| 共鸣技能 - 一日花(入场) | 粉紫色 `(153,66,212)` | AND | 变奏入场时的一日花状态 |
| 声骸技能 | 白色 `(255,255,255)` | OR | 声骸技能就绪 |
| 共鸣解放 | 白色/粉紫 `(255,255,255)/(153,66,212)` | OR | 大招就绪 |

## 角色机制

椿有两种形态：
- **白椿** - 常规形态，通过 E（红椿盛绽）进入红椿状态
- **红椿** - 盛绽状态，攻击会消耗【红椿·蕊】，通过 E（黯蕊猎心）退出

**一日花** 是特殊的 E 技能，出现条件为积攒足够的红椿·蕾。一日花会清除已有的红椿·蕾。

## 连招片段

### 白椿形态

| 方法 | 描述 | 动作序列概要 |
|------|------|-------------|
| `a4()` | 白椿4段普攻 | 连续快速普攻4次 |
| `a3()` | 随便打几下 | 3次普攻，用于入场防止变奏吞操作 |
| `a3z()` | 白椿3段普攻+转圈派生 | 3次普攻接长按重击转圈 |
| `waz()` | 从a2继续打+转圈派生 | 前进+普攻+长按重击转圈 |
| `z()` | 白椿重击转圈 | 长按4.78秒转圈 |

### 红椿形态

| 方法 | 描述 | 动作序列概要 |
|------|------|-------------|
| `Eaazja()` | 白→红普攻重击转圈下砸 | E+2a+重击转圈+下砸+普攻 |
| `aazja()` | 红椿普攻重击转圈下砸 | 2a+重击转圈+下砸+普攻 |
| `Ezja()` | 白→红重击转圈下砸 | E+重击转圈+下砸+普攻 |
| `zja()` | 红椿重击转圈下砸 | 重击转圈+下砸+普攻 |
| `ja()` | 落地退出红椿 | 跳跃+普攻落地 |

### 进阶操作

| 方法 | 描述 | 动作序列概要 |
|------|------|-------------|
| `EQdzjE()` | Q闪取消转红椿+三连鞭 | E+Q+闪避+长按重击+跳跃+E |
| `QdEj()` | 红椿Q闪取消转白椿 | Q+闪避+E+跳跃 |
| `ephemeral_a()` | 一日花下砸 | E×4+普攻落地 |

### 大招

| 方法 | 描述 | 动作序列概要 |
|------|------|-------------|
| `R()` | 共鸣解放 | R×4（冗余多按） |
| `RaRa()` | 共鸣解放+穿插普攻 | R和a交替，等R结束后放一日花 |

## 连招决策逻辑 (`combo()`)

```
入场: a3() 打几下普攻（防变奏吞操作）

截图检测技能状态

阶段1 - 优先处理特殊状态:
├─ 一日花就绪 AND 大招就绪 → RaRa() + ephemeral_a()
├─ 一日花就绪 → ephemeral_a()
└─ 大招就绪 → R()

阶段2 - 白椿/红椿连招:
├─ 白椿 (红椿盛绽就绪):
│   ├─ 冥歌海墟模式 → QdEj()
│   └─ 正常模式 → 50%概率 waz() / 50%概率 EQdzjE()
├─ 红椿 (黯蕊猎心就绪):
│   ├─ 冥歌海墟模式 → zja()
│   └─ 正常模式 → EQdzjE()
└─ 兜底 → a4() 普攻4段

阶段3 - 再次检查:
├─ 一日花就绪 AND 大招就绪 → boss血量>30%时RaRa() + ephemeral_a()
├─ 一日花就绪 → ephemeral_a()
└─ 大招就绪 → RaRa() + 再检查一日花
```

## 特殊处理

### `exit_special_state()`

战斗结束移动前调用，用于退出红椿盛绽状态。执行 `ja()` 跳跃+普攻落地动作（设置 `ignore_event=True` 忽略暂停事件），然后 `dash_dodge()` 后闪复位防止椿前移偏离。

### 冗余操作设计

椿的连招中大量使用了冗余操作：
- **多次按 E** - 确保E技能释放成功
- **多次按 R** - 确保大招释放成功
- **RaRa 交替** - R和普攻交替确保不卡住
- **拆分长等待** - 将长时间等待拆分为多个短操作

---

*最后更新: 2026-02-06*
