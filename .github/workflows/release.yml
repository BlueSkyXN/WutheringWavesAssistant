name: Release Build

on:
  workflow_dispatch:

jobs:
  package:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0  # è·å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾çš„å®Œæ•´å†å²è®°å½•

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“– è·å–WWAç‰ˆæœ¬å·
        id: get_version
        run: |
          $line = (Select-String -Path "src/__init__.py" -Pattern '__version__\s*=\s*"(.*?)"').Matches.Groups[1].Value
          $version = $line.Trim() -split ' ' | Select-Object -First 1
          Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "WWA version: $version"

      - name: ğŸ—œï¸ æ¸…ç†ä¸ç”¨æ‰“åŒ…çš„é¡¹ç›®æ–‡ä»¶
        run: |
          # Remove-Item -Path ".git" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".github" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "assets/screenshot" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "docs" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "logs" -Recurse -Force -ErrorAction SilentlyContinue
          # Remove-Item -Path "tests" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "src/c" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "src/gui/resource" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".pre-commit-config.yaml" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "WWA_updater.exe" -Recurse -Force -ErrorAction SilentlyContinue
          
          $tempWorkspace = "temp-workspace"
          mkdir $tempWorkspace -Force
          Write-Output "TEMP_WORKSPACE=$tempWorkspace" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # å¤åˆ¶å½“å‰ç›®å½•å†…å®¹ï¼Œæ’é™¤ temp-workspace
          Get-ChildItem -Path . -Force | Where-Object { $_.Name -ne $tempWorkspace } | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination $tempWorkspace -Recurse -Force
          }

      - name: ğŸ ä¸‹è½½ Python 3.12 å®Œæ•´ ZIP
        run: |
          $pyZipName = "python-3.12.6-amd64.zip"
          $url = "https://www.python.org/ftp/python/3.12.6/$pyZipName"
          Invoke-WebRequest -Uri $url -OutFile $pyZipName
          Write-Output "PY_ZIP_NAME=$pyZipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: â¬‡ï¸ ä¸‹è½½æœ€å° MinGit
        run: |
          $gitUrl = "https://github.com/git-for-windows/git/releases/download/v2.51.0.windows.1/MinGit-2.51.0-64-bit.zip"
          $gitFile = "MinGit.zip"
          Invoke-WebRequest -Uri $gitUrl -OutFile $gitFile
          Expand-Archive -Path $gitFile -DestinationPath "$env:TEMP_WORKSPACE\git"

      - name: ğŸ§‘â€ğŸ’» wwa cpuç‰ˆæœ¬ å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        run: |
          # è§£å‹ Python åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $env:PY_ZIP_NAME -DestinationPath "$env:TEMP_WORKSPACE\py312"
          
          # åˆ‡å…¥ä¸´æ—¶ç›®å½•
          Push-Location "$env:TEMP_WORKSPACE"
          
          # å®‰è£…ä¾èµ–åˆ°ä¾¿æº Python
          & "py312\python.exe" -m pip install --upgrade pip
          & "py312\python.exe" -m pip install setuptools wheel
          & "py312\python.exe" -m pip install poetry==2.1.1
          & "py312\python.exe" -m poetry config virtualenvs.create false
          & "py312\python.exe" -m poetry install -E cpu --no-root -v
          & "py312\python.exe" -m pip list
          
          # æ‰“åŒ…åˆ°ä¸Šä¸€çº§ç›®å½•
          7z a -mx=9 "..\wwa-${{ env.VERSION }}.7z" "*"
          
          # æ¸…ç†ä¸´æ—¶ Python
          Remove-Item "py312" -Recurse -Force -ErrorAction SilentlyContinue
          
          # å›åˆ°åŸç›®å½•
          Pop-Location

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: wwa
          path: "wwa-${{ env.VERSION }}.7z"

      - name: ğŸ§‘â€ğŸ’» wwa gpu cuda12.6ç‰ˆæœ¬ å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        run: |
          # è§£å‹ Python åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $env:PY_ZIP_NAME -DestinationPath "$env:TEMP_WORKSPACE\py312"

          # åˆ‡å…¥ä¸´æ—¶ç›®å½•
          Push-Location "$env:TEMP_WORKSPACE"

          # å®‰è£…ä¾èµ–åˆ°ä¾¿æº Python
          & "py312\python.exe" -m pip install --upgrade pip
          & "py312\python.exe" -m pip install setuptools wheel
          & "py312\python.exe" -m pip install poetry==2.1.1
          & "py312\python.exe" -m poetry config virtualenvs.create false
          & "py312\python.exe" -m poetry install -E cuda --no-root -v
          & "py312\python.exe" -m pip list

          # æ‰“åŒ…åˆ°ä¸Šä¸€çº§ç›®å½•
          7z a -mx=9 "..\wwa-gpu-cu126-${{ env.VERSION }}.7z" "*"

          # æ¸…ç†ä¸´æ—¶ Python
          Remove-Item "py312" -Recurse -Force -ErrorAction SilentlyContinue

          # å›åˆ°åŸç›®å½•
          Pop-Location

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: wwa-gpu-cu126
          path: "wwa-gpu-cu126-${{ env.VERSION }}.7z"

      - name: ğŸ§‘â€ğŸ’» wwa gpu cuda11.8ç‰ˆæœ¬ å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        run: |
          # è§£å‹ Python åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $env:PY_ZIP_NAME -DestinationPath "$env:TEMP_WORKSPACE\py312"

          # åˆ‡å…¥ä¸´æ—¶ç›®å½•
          Push-Location "$env:TEMP_WORKSPACE"

          # å®‰è£…ä¾èµ–åˆ°ä¾¿æº Python
          & "py312\python.exe" -m pip install --upgrade pip
          & "py312\python.exe" -m pip install setuptools wheel
          & "py312\python.exe" -m pip install poetry==2.1.1
          & "py312\python.exe" -m poetry config virtualenvs.create false
          & "py312\python.exe" -m poetry install -E cuda11 --no-root -v
          & "py312\python.exe" -m pip list

          # æ‰“åŒ…åˆ°ä¸Šä¸€çº§ç›®å½•
          7z a -mx=9 "..\wwa-gpu-cu118-${{ env.VERSION }}.7z" "*"

          # æ¸…ç†ä¸´æ—¶ Python
          Remove-Item "py312" -Recurse -Force -ErrorAction SilentlyContinue

          # å›åˆ°åŸç›®å½•
          Pop-Location

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: wwa-gpu-cu118
          path: "wwa-gpu-cu118-${{ env.VERSION }}.7z"

      - name: æå–æœ€æ–°ç‰ˆæœ¬å˜æ›´è®°å½•
        id: extract_changelog
        shell: pwsh
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "CHANGELOG.md")) {
              Write-Output "CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨"
              "" | Out-File -FilePath "release_body.txt"
              exit 0
          }

          # è¯»å–æ–‡ä»¶å†…å®¹
          $content = Get-Content -Path "CHANGELOG.md" -Raw

          # é€è¡Œå¤„ç†ï¼Œæå–ç¬¬ä¸€ä¸ªç‰ˆæœ¬å—
          $lines = $content -split "`n"
          $firstBlock = @()
          $foundFirst = $false
          $collecting = $false

          foreach ($line in $lines) {
              if ($line -match '^[vV]\d+\.\d+\.\d+') {
                  if (-not $foundFirst) {
                      $foundFirst = $true
                      $collecting = $true
                      $firstBlock += $line
                  } else {
                      # é‡åˆ°ç¬¬äºŒä¸ªç‰ˆæœ¬å·ï¼Œåœæ­¢æ”¶é›†
                      break
                  }
              } elseif ($collecting) {
                  $firstBlock += $line
              }
          }

          # å¤„ç†ç»“æœ
          if ($firstBlock.Count -gt 0) {
              $result = ($firstBlock -join "`n").Trim()
              Write-Output "æå–å˜æ›´è®°å½•ï¼š"
              Write-Output $result
              # ä¿å­˜åˆ°æ–‡ä»¶
              $result | Out-File -FilePath "release_body.txt"
          } else {
              Write-Output "æœªæå–åˆ°ç‰ˆæœ¬ä¿¡æ¯"
              "" | Out-File -FilePath "release_body.txt"
          }
          
          # ç»„åˆå›ºå®šè¯æœ¯å’ŒåŠ¨æ€ç‰ˆæœ¬è®°å½•
          $fixedText = @"
          ğŸ‰ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼**
          
          æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
          
          ğŸ“¦ **ä¸‹è½½è¯´æ˜ï¼š**
          - `wwa-*.7z` - æ ‡å‡†é€šç”¨ç‰ˆæœ¬ï¼Œæ–‡ä»¶è¾ƒå°ï¼Œé€‚åˆç½‘é€Ÿæ…¢çš„æˆ–AMDæ˜¾å¡çš„ç”¨æˆ·
          - `wwa-gpu-cu118-*.7z` - NVIDIAæ˜¾å¡ä¸“å±ï¼ŒGPUåŠ é€Ÿé€šç”¨ç‰ˆï¼Œé€‚åˆä»»æ„Nå¡
          - `wwa-gpu-cu126-*.7z` - NVIDIAæ˜¾å¡ä¸“å±ï¼ŒGPUåŠ é€Ÿæ–°ç‰ˆï¼Œé€‚åˆ30ã€40ã€50ç³»åˆ—æ˜¾å¡
          ç‰¹æ®Šï¼š5090ç³»åˆ—å¤ªæ–°ï¼ŒGPUç‰ˆè¿˜ä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨æ ‡å‡†ç‰ˆ
          è„šæœ¬å…å®‰è£…è§£å‹å³å¯è¿è¡Œï¼Œæ¸¸æˆéœ€è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡ï¼Œé‡ç½®æŒ‰é”®ï¼Œé‡ç½®æ»¤é•œï¼Œé‡ç½®äº®åº¦
          
          âš¡ **æ›´æ–°å†…å®¹ï¼š**
          
          "@

          $fullContent = $fixedText + "`n`n" + $changelogContent + "`n`n" + "æ„Ÿè°¢ä½¿ç”¨ï¼å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issueã€‚"
    
          # ä¿å­˜åˆ°æ–‡ä»¶
          $fullContent | Out-File -FilePath "release_body.txt"

      - name: ğŸš€ å‘å¸ƒ GitHub Releaseï¼ˆä»… main åˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "Release ${{ env.VERSION }}"
          files: |
            "wwa-${{ env.VERSION }}.7z"
            "wwa-gpu-cu126-${{ env.VERSION }}.7z"
            "wwa-gpu-cu118-${{ env.VERSION }}.7z"
#          body: |
#            ğŸ‰ è¿™æ˜¯ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒçš„ç‰ˆæœ¬ï¼
#            ${{ steps.changelog.outputs.changelog }}
          body_path: "release_body.txt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
