name: Release Build

on:
  workflow_dispatch:

jobs:
  package:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0  # è·å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾çš„å®Œæ•´å†å²è®°å½•

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“– è·å–WWAç‰ˆæœ¬å·
        id: get_version
        run: |
          $line = (Select-String -Path "src/__init__.py" -Pattern '__version__\s*=\s*"(.*?)"').Matches.Groups[1].Value
          $version = $line.Trim() -split ' ' | Select-Object -First 1
          Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "WWA version: $version"

      - name: ğŸ—œï¸ æ¸…ç†ä¸ç”¨æ‰“åŒ…çš„é¡¹ç›®æ–‡ä»¶
        run: |
          # Remove-Item -Path ".git" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".github" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "assets/screenshot" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "docs" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "logs" -Recurse -Force -ErrorAction SilentlyContinue
          # Remove-Item -Path "tests" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "src/c" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "src/gui/resource" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".pre-commit-config.yaml" -Recurse -Force -ErrorAction SilentlyContinue
          
          $tempWorkspace = "temp-workspace"
          mkdir $tempWorkspace -Force
          Write-Output "TEMP_WORKSPACE=$tempWorkspace" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # å¤åˆ¶å½“å‰ç›®å½•å†…å®¹ï¼Œæ’é™¤ temp-workspace
          Get-ChildItem -Path . -Force | Where-Object { $_.Name -ne $tempWorkspace } | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination $tempWorkspace -Recurse -Force
          }

      - name: ğŸ ä¸‹è½½ Python 3.12 å®Œæ•´ ZIP
        run: |
          $pyZipName = "python-3.12.6-amd64.zip"
          $url = "https://www.python.org/ftp/python/3.12.6/$pyZipName"
          Invoke-WebRequest -Uri $url -OutFile $pyZipName
          Write-Output "PY_ZIP_NAME=$pyZipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: â¬‡ï¸ ä¸‹è½½æœ€å° MinGit
        run: |
          $gitUrl = "https://github.com/git-for-windows/git/releases/download/v2.51.0.windows.1/MinGit-2.51.0-64-bit.zip"
          $gitFile = "MinGit.zip"
          Invoke-WebRequest -Uri $gitUrl -OutFile $gitFile
          Expand-Archive -Path $gitFile -DestinationPath "$env:TEMP_WORKSPACE\git"

      - name: ğŸ§‘â€ğŸ’» wwa cpuç‰ˆæœ¬ å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        run: |
          # è§£å‹ Python åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $env:PY_ZIP_NAME -DestinationPath "$env:TEMP_WORKSPACE\py312"
          
          # åˆ‡å…¥ä¸´æ—¶ç›®å½•
          Push-Location "$env:TEMP_WORKSPACE"
          
          # å®‰è£…ä¾èµ–åˆ°ä¾¿æº Python
          & "py312\python.exe" -m pip install --upgrade pip
          & "py312\python.exe" -m pip install setuptools wheel
          & "py312\python.exe" -m pip install poetry==2.1.1
          & "py312\python.exe" -m poetry config virtualenvs.create false
          & "py312\python.exe" -m poetry install -E cpu --no-root -v
          & "py312\python.exe" -m pip list
          
          # æ‰“åŒ…åˆ°ä¸Šä¸€çº§ç›®å½•
          7z a -mx=9 "..\wwa-${{ env.VERSION }}.7z" "*"
          
          # æ¸…ç†ä¸´æ—¶ Python
          Remove-Item "py312" -Recurse -Force -ErrorAction SilentlyContinue
          
          # å›åˆ°åŸç›®å½•
          Pop-Location

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: wwa
          path: "wwa-${{ env.VERSION }}.7z"

      - name: ğŸ§‘â€ğŸ’» wwa gpuç‰ˆæœ¬ å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
        run: |
          # è§£å‹ Python åˆ°ä¸´æ—¶ç›®å½•
          Expand-Archive -Path $env:PY_ZIP_NAME -DestinationPath "$env:TEMP_WORKSPACE\py312"
          
          # åˆ‡å…¥ä¸´æ—¶ç›®å½•
          Push-Location "$env:TEMP_WORKSPACE"
          
          # å®‰è£…ä¾èµ–åˆ°ä¾¿æº Python
          & "py312\python.exe" -m pip install --upgrade pip
          & "py312\python.exe" -m pip install setuptools wheel
          & "py312\python.exe" -m pip install poetry==2.1.1
          & "py312\python.exe" -m poetry config virtualenvs.create false
          & "py312\python.exe" -m poetry install -E cuda --no-root -v
          & "py312\python.exe" -m pip list
          
          # æ‰“åŒ…åˆ°ä¸Šä¸€çº§ç›®å½•
          7z a -mx=9 "..\wwa-gpu-${{ env.VERSION }}.7z" "*"
          
          # æ¸…ç†ä¸´æ—¶ Python
          Remove-Item "py312" -Recurse -Force -ErrorAction SilentlyContinue
          
          # å›åˆ°åŸç›®å½•
          Pop-Location

      - name: ğŸ“‚ ä¸Šä¼  7z æ–‡ä»¶ä½œä¸º workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: wwa-gpu
          path: "wwa-gpu-${{ env.VERSION }}.7z"

      - name: ğŸš€ å‘å¸ƒ GitHub Releaseï¼ˆä»… main åˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "Release ${{ env.VERSION }}"
          files: |
            "wwa-${{ env.VERSION }}.7z"
            "wwa-gpu-${{ env.VERSION }}.7z"
          body: |
            Wuthering Waves Assistant
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
